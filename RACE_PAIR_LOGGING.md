# Race Pair Logging Enhancement

## 概述

为syzkaller的并发模式添加了完整的UAF/Race pair执行日志记录功能，支持每次执行时记录程序对，并在发现新的UAF/Race pair时保存详细日志到本地文件，同时在manager的race-corpus中维护日志文件路径用于后续程序还原。

## 实现的功能

### 1. 程序对执行日志记录 (syz-fuzzer/proc.go)

- **logProgramPair()**: 在每次执行test pair时记录程序对
- 支持多种输出模式：
  - `OutputStdout`: 控制台输出，格式与syz-execprog兼容
  - `OutputDmesg`: 内核消息日志输出  
  - `OutputFile`: 文件输出
- 输出格式：
  ```
  HH:MM:SS executing program pair PID:
  Program 1:
  [程序1内容]
  Program 2:
  [程序2内容]
  ```

### 2. Race Pair发现时日志保存

- **saveRacePairLogToPath()**: 当发现新的race pair时保存完整日志
- **generateRacePairLogPath()**: 生成标准化的日志文件路径
- 日志文件特点：
  - 存储在 `race_logs/` 目录下
  - 文件名格式：`race_pair_YYYYMMDD_HHMMSS_[PairID].log`
  - 包含元数据和race详细信息
  - 与syz-execprog格式完全兼容

### 3. 日志文件格式 (syz-execprog兼容)

```
# Race Pair Log - Generated by syz-fuzzer
# Timestamp: 2025-09-21T15:30:45Z
# Pair ID: abc123def456
# Fuzzer: fuzzer-name
# Proc ID: 1
# Race Count: 2

YYYY/MM/DD HH:MM:SS executing program 1:
[第一个程序的syzkaller代码]

YYYY/MM/DD HH:MM:SS executing program 2:
[第二个程序的syzkaller代码]

# Race Pair Details:
# Race 1: Signal=0x12345, VarName1=100, VarName2=200
# Race 2: Signal=0x67890, VarName1=300, VarName2=400
```

### 4. Manager端Race Corpus扩展 (syz-manager/manager.go)

- **RaceCorpusItem结构扩展**: 添加了`LogPath`字段
- **saveRaceCorpusItem()更新**: 保存日志文件路径到race corpus
- 支持通过日志路径进行程序还原和重现

### 5. RPC协议扩展 (pkg/rpctype/rpctype.go)

- **RacePairInput结构扩展**: 添加了`LogPath`字段
- 支持fuzzer向manager传递日志文件路径信息

## 使用方法

### 启用日志记录

1. **标准模式**: syz-fuzzer会在test pair模式下自动记录每次执行
2. **详细日志**: 使用`-output`参数控制输出模式

### 查看Race Pair日志

1. **本地日志文件**: 查看`race_logs/`目录下的`.log`文件
2. **Manager corpus**: 通过Web界面或API查看race corpus中的LogPath字段

### 使用syz-execprog还原

生成的日志文件可以直接用于syz-execprog进行程序还原：

```bash
# 执行保存的race pair程序
./syz-execprog -os=linux -arch=amd64 race_logs/race_pair_20250921_153045_abc123def.log

# 带race validation执行
./syz-execprog -race-validation -race-signal=0x12345 prog1.log prog2.log
```

## 实现细节

### 文件修改列表

1. **syz-fuzzer/proc.go**:
   - 添加`logProgramPair()`方法
   - 添加`saveRacePairLogToPath()`和`generateRacePairLogPath()`方法
   - 修改`executeTestPair()`以支持日志记录
   - 修改`sendRacePairsToManager()`以包含日志路径

2. **syz-manager/manager.go**:
   - 扩展`RaceCorpusItem`结构添加`LogPath`字段
   - 更新`saveRaceCorpusItem()`以保存日志路径

3. **pkg/rpctype/rpctype.go**:
   - 扩展`RacePairInput`结构添加`LogPath`字段

### 兼容性

- **向后兼容**: 所有修改都是向后兼容的，不影响现有功能
- **syz-execprog兼容**: 生成的日志文件完全符合syz-execprog的解析格式
- **多格式支持**: 支持prog.ParseLog()解析生成的日志文件

## 性能影响

- **最小化开销**: 只在发现新race pair时才写入文件
- **异步处理**: 日志写入不阻塞主执行流程
- **存储优化**: 使用压缩的时间戳和ID格式

## 后续扩展建议

1. **日志压缩**: 对老旧日志文件进行自动压缩
2. **日志轮转**: 实现基于大小或时间的日志轮转
3. **远程同步**: 支持将日志同步到远程存储
4. **Web界面**: 在manager Web界面中集成日志查看功能